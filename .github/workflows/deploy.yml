name: Deploy Workflow

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Deploy a specific tag (e.g., sha-<commit> or prod). Leave empty to deploy sha-<this commit>."
        required: false
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      # Docker Hub repositories
      DOCKER_IMAGE_NAME_PRODUCT: product-service
      DOCKER_IMAGE_NAME_INFERENCE: inference-service

      EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      EC2_PUBLIC_IP_ADDRESS: ${{ secrets.EC2_PUBLIC_IP_ADDRESS }}

      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # App defaults (you can move these to GitHub secrets if you prefer)
      POSTGRES_USER: amigoscode
      POSTGRES_PASSWORD: password
      POSTGRES_DB: jfs
      AWS_REGION: us-east-1
      MODEL_HOST_PATH: /home/ubuntu/my-mlops-demo/models/model.pkl
